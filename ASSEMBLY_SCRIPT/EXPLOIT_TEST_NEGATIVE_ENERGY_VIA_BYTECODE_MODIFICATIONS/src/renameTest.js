import loader from '@assemblyscript/loader'
import metering from 'wasm-metering'
import fs from 'fs'


//Get our wasm version with EMFR(Energy Metering Function Renaming)
const randomEnergyFunc = fs.readFileSync('./rename.wasm')

console.log('Pure bytecode => ',randomEnergyFunc)


//------------------- Лимиты энергии -------------------
//------------------- Energy limits --------------------

const energyLimit = 2000000
let energyUsed = 0


let wasmMetered = await loader.instantiate(randomEnergyFunc,{
    
    metering: {
      
        usegas: energy => {

            energyUsed += energy
            
            if (energyUsed > energyLimit) throw new Error('No more energy!')
        }
        
    }

});


const result = wasmMetered.exports.justATest(100,20);


//Energy must be negative
console.log(`Result:${result}, energy used ${energyUsed * 1e-4}`);